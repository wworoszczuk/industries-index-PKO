<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INDEKS BRAN≈ª - PKO BP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @font-face {
            font-family: 'Mina';
            src: url('../assets/mina/Mina-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Mina';
            src: url('../assets/mina/Mina-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Mina', 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #f7f8fa 0%, #e8eef5 100%);
            color: #0B1C4A;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #0B1C4A 0%, #1a3a6b 100%);
            color: white;
            padding: 30px 40px;
            box-shadow: 0 4px 12px rgba(11, 28, 74, 0.15);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        #logo {
            height: 50px;
            width: auto;
        }

        .header-title h1 {
            font-weight: bold;
            letter-spacing: 3px;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-title p {
            font-size: 0.9rem;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .header-nav a:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: white;
            transform: translateY(-2px);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Controls Panel */
        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: bold;
            color: #0B1C4A;
            margin-bottom: 10px;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .control-group select {
            padding: 14px 16px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-family: 'Mina', sans-serif;
            font-size: 1rem;
            background: white;
            color: #0B1C4A;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-group select:hover {
            border-color: #0B1C4A;
        }

        .control-group select:focus {
            outline: none;
            border-color: #0B1C4A;
            box-shadow: 0 0 0 3px rgba(11, 28, 74, 0.1);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .main-chart {
            grid-column: span 12;
        }

        .stat-card {
            grid-column: span 3;
        }

        .chart-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }

        .chart-header h2 {
            color: #0B1C4A;
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .chart-header p {
            color: #6b7a90;
            font-size: 0.95rem;
        }

        /* Stats Cards */
        .stat-value {
            font-size: 3rem;
            font-weight: bold;
            color: #0B1C4A;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #6b7a90;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-change {
            margin-top: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            display: inline-block;
        }

        .stat-change.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .stat-change.negative {
            background: #ffebee;
            color: #c62828;
        }

        .stat-change.neutral {
            background: #f0f4f8;
            color: #6b7a90;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #6b7a90;
        }

        .loading-spinner {
            border: 4px solid #f0f4f8;
            border-top: 4px solid #0B1C4A;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: #6b7a90;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stat-card {
                grid-column: span 6;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .stat-card {
                grid-column: span 12;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-left">
                <img src="assets/logo.svg" alt="Logo PKO BP" id="logo">
                <div class="header-title">
                    <h1>INDEKS BRAN≈ª</h1>
                    <p>Dashboard analityczny</p>
                </div>
            </div>
            <div class="header-nav">
                <a href="./metodologia.html">METODOLOGIA</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Controls Panel -->
        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="sectionSelect">SEKCJA PKD</label>
                    <select id="sectionSelect">
                        <option value="">Wszystkie sekcje</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="divisionSelect">DZIA≈Å PKD</label>
                    <select id="divisionSelect">
                        <option value="">Wybierz dzia≈Ç...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="yearRange">ZAKRES LAT</label>
                    <select id="yearRange">
                        <option value="all">2018-2024 (wszystkie)</option>
                        <option value="recent">2021-2024 (ostatnie 3 lata)</option>
                        <option value="2024">2024 (bie≈ºƒÖcy rok)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="dashboard-grid">
            <div class="chart-card stat-card">
                <div class="stat-value" id="totalBankruptcies">-</div>
                <div class="stat-label">Ca≈Çkowita liczba upad≈Ço≈õci</div>
                <div class="stat-change neutral" id="bankruptcyChange">-</div>
            </div>

            <div class="chart-card stat-card">
                <div class="stat-value" id="avgBankruptcies">-</div>
                <div class="stat-label">≈örednia rocznie</div>
                <div class="stat-change neutral" id="avgChange">-</div>
            </div>

            <div class="chart-card stat-card">
                <div class="stat-value" id="peakYear">-</div>
                <div class="stat-label">Rok szczytowy</div>
                <div class="stat-change neutral" id="peakValue">-</div>
            </div>

            <div class="chart-card stat-card">
                <div class="stat-value" id="trendIndicator">-</div>
                <div class="stat-label">Trend</div>
                <div class="stat-change neutral" id="trendValue">-</div>
            </div>
        </div>

        <!-- Main Chart -->
        <div class="dashboard-grid">
            <div class="chart-card main-chart">
                <div class="chart-header">
                    <h2>Liczba upad≈Ço≈õci firm w czasie</h2>
                    <p id="chartSubtitle">Analiza trend√≥w w wybranym dziale PKD</p>
                </div>
                <div style="position: relative; height: 450px;">
                    <canvas id="bankruptcyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="loading-spinner"></div>
            <p>≈Åadowanie danych...</p>
        </div>
    </div>

    <footer>
        <p>Made with ‚ù§Ô∏è for PKO BP | Dane: PKD 2025 | System wczesnego ostrzegania dla sektora bankowego</p>
    </footer>

    <script>
        let wskaznikiData = null;
        let pkdData = null;
        let currentChart = null;

        // Load data files
        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                
                const [wskaznikiResponse, pkdResponse] = await Promise.all([
                    fetch('../data/wskazniki.json'),
                    fetch('../data/PKD.json')
                ]);

                wskaznikiData = await wskaznikiResponse.json();
                pkdData = await pkdResponse.json();

                populateSectionSelect();
                populateDivisionSelect();
                updateDashboard();

                document.getElementById('loadingIndicator').style.display = 'none';
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania danych:', error);
                document.getElementById('loadingIndicator').innerHTML = 
                    '<p style="color: #c62828;">B≈ÇƒÖd wczytywania danych. Sprawd≈∫ ≈õcie≈ºki do plik√≥w JSON.</p>';
            }
        }

        // Populate section dropdown
        function populateSectionSelect() {
            const select = document.getElementById('sectionSelect');
            const sections = pkdData.PKD.sections;
            
            for (const [code, section] of Object.entries(sections)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${section.name}`;
                select.appendChild(option);
            }
        }

        // Populate division dropdown based on selected section
        function populateDivisionSelect(sectionCode = null) {
            const select = document.getElementById('divisionSelect');
            select.innerHTML = '<option value="">Wszystkie dzia≈Çy</option>';

            let divisions = {};

            if (sectionCode) {
                divisions = pkdData.PKD.sections[sectionCode].divisions;
            } else {
                // All divisions from all sections
                for (const section of Object.values(pkdData.PKD.sections)) {
                    Object.assign(divisions, section.divisions);
                }
            }

            for (const [code, name] of Object.entries(divisions).sort()) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${name}`;
                select.appendChild(option);
            }
        }

        // Update dashboard based on selections
        function updateDashboard() {
            const divisionCode = document.getElementById('divisionSelect').value;
            const yearRange = document.getElementById('yearRange').value;

            if (!divisionCode) {
                // Show aggregate data
                updateAggregateView(yearRange);
            } else {
                // Show specific division data
                updateDivisionView(divisionCode, yearRange);
            }
        }

        // Update view for specific division
        function updateDivisionView(divisionCode, yearRange) {
            const divisionData = wskaznikiData.divisions[divisionCode];
            if (!divisionData) return;

            const years = getYearsInRange(yearRange);
            const bankruptcies = years.map(year => 
                divisionData.years[year]?.firms?.bankruptcies || 0
            );

            // Update stats
            const total = bankruptcies.reduce((a, b) => a + b, 0);
            const avg = (total / years.length).toFixed(1);
            const maxValue = Math.max(...bankruptcies);
            const maxYear = years[bankruptcies.indexOf(maxValue)];
            
            const lastYear = bankruptcies[bankruptcies.length - 1];
            const prevYear = bankruptcies[bankruptcies.length - 2];
            const change = prevYear > 0 ? (((lastYear - prevYear) / prevYear) * 100).toFixed(1) : 0;

            document.getElementById('totalBankruptcies').textContent = total;
            document.getElementById('avgBankruptcies').textContent = avg;
            document.getElementById('peakYear').textContent = maxYear;
            document.getElementById('peakValue').textContent = `${maxValue} upad≈Ço≈õci`;
            
            updateChangeIndicator('bankruptcyChange', change, '%');
            updateTrendIndicator(bankruptcies);

            // Update chart
            document.getElementById('chartSubtitle').textContent = 
                `${divisionCode} - ${divisionData.name}`;
            
            updateChart(years, bankruptcies, divisionData.name);
        }

        // Update view for aggregate data
        function updateAggregateView(yearRange) {
            const years = getYearsInRange(yearRange);
            const aggregatedData = {};

            // Aggregate all divisions
            years.forEach(year => {
                aggregatedData[year] = 0;
                for (const division of Object.values(wskaznikiData.divisions)) {
                    const value = division.years[year]?.firms?.bankruptcies;
                    if (value !== null && value !== undefined) {
                        aggregatedData[year] += value;
                    }
                }
            });

            const bankruptcies = years.map(year => aggregatedData[year]);
            const total = bankruptcies.reduce((a, b) => a + b, 0);
            const avg = (total / years.length).toFixed(1);
            const maxValue = Math.max(...bankruptcies);
            const maxYear = years[bankruptcies.indexOf(maxValue)];
            
            const lastYear = bankruptcies[bankruptcies.length - 1];
            const prevYear = bankruptcies[bankruptcies.length - 2];
            const change = prevYear > 0 ? (((lastYear - prevYear) / prevYear) * 100).toFixed(1) : 0;

            document.getElementById('totalBankruptcies').textContent = total;
            document.getElementById('avgBankruptcies').textContent = avg;
            document.getElementById('peakYear').textContent = maxYear;
            document.getElementById('peakValue').textContent = `${maxValue} upad≈Ço≈õci`;
            
            updateChangeIndicator('bankruptcyChange', change, '%');
            updateTrendIndicator(bankruptcies);

            document.getElementById('chartSubtitle').textContent = 
                'Wszystkie dzia≈Çy PKD - agregowane dane';
            
            updateChart(years, bankruptcies, 'Wszystkie bran≈ºe');
        }

        // Get years based on range selection
        function getYearsInRange(range) {
            const allYears = ['2018', '2019', '2020', '2021', '2022', '2023', '2024'];
            
            switch(range) {
                case 'recent':
                    return ['2021', '2022', '2023', '2024'];
                case '2024':
                    return ['2024'];
                default:
                    return allYears;
            }
        }

        // Update change indicator
        function updateChangeIndicator(elementId, change, suffix = '') {
            const element = document.getElementById(elementId);
            const changeNum = parseFloat(change);
            
            if (changeNum > 0) {
                element.className = 'stat-change negative';
                element.textContent = `‚ñ≤ ${change}${suffix} wzrost`;
            } else if (changeNum < 0) {
                element.className = 'stat-change positive';
                element.textContent = `‚ñº ${Math.abs(change)}${suffix} spadek`;
            } else {
                element.className = 'stat-change neutral';
                element.textContent = 'Bez zmian';
            }
        }

        // Update trend indicator
        function updateTrendIndicator(data) {
            const trend = calculateTrend(data);
            const trendElement = document.getElementById('trendIndicator');
            const trendValueElement = document.getElementById('trendValue');
            
            if (trend > 0.1) {
                trendElement.textContent = 'üìà';
                trendValueElement.className = 'stat-change negative';
                trendValueElement.textContent = 'Trend rosnƒÖcy';
            } else if (trend < -0.1) {
                trendElement.textContent = 'üìâ';
                trendValueElement.className = 'stat-change positive';
                trendValueElement.textContent = 'Trend malejƒÖcy';
            } else {
                trendElement.textContent = '‚û°Ô∏è';
                trendValueElement.className = 'stat-change neutral';
                trendValueElement.textContent = 'Trend stabilny';
            }
        }

        // Calculate trend (simple linear regression slope)
        function calculateTrend(data) {
            const n = data.length;
            const xMean = (n - 1) / 2;
            const yMean = data.reduce((a, b) => a + b, 0) / n;
            
            let numerator = 0;
            let denominator = 0;
            
            for (let i = 0; i < n; i++) {
                numerator += (i - xMean) * (data[i] - yMean);
                denominator += (i - xMean) ** 2;
            }
            
            return denominator !== 0 ? numerator / denominator : 0;
        }

        // Update chart
        function updateChart(labels, data, label) {
            const ctx = document.getElementById('bankruptcyChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: '#0B1C4A',
                        backgroundColor: 'rgba(11, 28, 74, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#0B1C4A',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(11, 28, 74, 0.95)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 12, family: 'Mina' },
                                color: '#6b7a90'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 12, family: 'Mina', weight: 'bold' },
                                color: '#0B1C4A'
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('sectionSelect').addEventListener('change', (e) => {
            populateDivisionSelect(e.target.value || null);
            updateDashboard();
        });

        document.getElementById('divisionSelect').addEventListener('change', updateDashboard);
        document.getElementById('yearRange').addEventListener('change', updateDashboard);

        // Initialize
        loadData();
    </script>
</body>
</html>